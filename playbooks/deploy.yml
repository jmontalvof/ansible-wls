---
- name: Desplegar aplicaciÃ³n en WebLogic
  hosts: weblogic_servers
  vars_files:
    - "../vars/{{ app_name }}.yml"
  environment:
    PATH: "{{ java_home }}/bin:{{ ansible_env.PATH }}"
    CLASSPATH: "{{ weblogic_home }}/wlserver/server/lib/weblogic.jar"

  tasks:
    - name: Definir variables de despliegue
      set_fact:
        war_path: "{{ paths.deploy_dir }}/{{ app_config.name }}/{{ app_config.name }}-{{ app_config.version }}.war"
        deploy_timestamp: "{{ ansible_date_time.iso8601 }}"

    - name: Verificar existencia del WAR
      stat:
        path: "{{ war_path }}"
      register: war_stat

    - name: Ejecutar despliegue WebLogic
      command: >
        java weblogic.Deployer
        -adminurl {{ weblogic_config.admin_url }}
        -username {{ wl_user }}
        -password {{ wl_pass }}
        -deploy -source {{ war_path }}
        -targets {{ weblogic_config.targets }}
        -name {{ app_config.name }}
        -appversion {{ app_config.version }}
        -timeout {{ weblogic_config.deploy_timeout }}
        -upload -remote -verbose
      register: deploy_result
      no_log: true
      when: war_stat.stat.exists

    - name: Validar resultado del despliegue
      assert:
        that:
          - "'deploy completed' in deploy_result.stdout"
        fail_msg: "Error en el despliegue: {{ deploy_result.stdout }}"
      when: war_stat.stat.exists

    - name: Registrar log de despliegue
      template:
        src: templates/deploy_log.j2
        dest: "{{ paths.logs_dir }}/deploy_{{ app_config.name }}_{{ app_config.version }}.log"
        mode: '0644'
      when: war_stat.stat.exists

    - name: Recuperar log para Jenkins
      fetch:
        src: "{{ paths.logs_dir }}/deploy_{{ app_config.name }}_{{ app_config.version }}.log"
        dest: "logs/"
        flat: yes
      when: war_stat.stat.exists
