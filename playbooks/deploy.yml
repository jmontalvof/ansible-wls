---
- name: Desplegar aplicación WAR en WebLogic
  hosts: all
  become: false
  vars_files:
    - vars/{{ app_name }}.yml

  tasks:

    - name: Definir fecha de despliegue
      set_fact:
        fecha_deploy: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"

    - name: Crear carpeta de logs si no existe
      file:
        path: "/opt/logs"
        state: directory
        mode: '0755'

    - name: Definir ruta completa del WAR
      set_fact:
        war_path: "/opt/deploy/{{ app_name }}/{{ app_name }}-{{ app_version }}.war"

    - name: Validar credenciales Nexus
      debug:
        msg:
          - "🧩 Usuario Nexus recibido: {{ nexus_user }}"
          - "🔐 Contraseña definida (>0): {{ nexus_pass is defined and nexus_pass | length > 0 }}"

    - name: Descargar WAR desde Nexus
      get_url:
        url: "{{ nexus_url }}/com/empresa/web/{{ app_name }}/{{ app_version }}/{{ app_name }}-{{ app_version }}.war"
        dest: "{{ war_path }}"
        mode: '0644'
        url_username: "{{ nexus_user }}"
        url_password: "{{ nexus_pass }}"
        use_netrc: false

    - name: Obtener hash SHA256 del WAR
      command: "sha256sum {{ war_path }}"
      register: war_hash_result
      changed_when: false

    - name: Verificar hash SHA256 del WAR descargado
      assert:
        that:
          - "war_hash_result.stdout.split()[0] == expected_sha256"
        fail_msg: "❌ El WAR descargado no coincide con el hash esperado: posible archivo corrupto"
        success_msg: "✅ Integridad del WAR confirmada con SHA256"

    - name: Desplegar WAR en WebLogic
      shell: |
        java weblogic.Deployer \
          -adminurl t3://{{ dominio }}:7001 \
          -username {{ wl_user }} \
          -password {{ wl_pass }} \
          -deploy {{ war_path }} \
          -targets {{ targets }} \
          -remote \
          -upload
      register: deploy_result
      environment:
        WL_USER: "{{ wl_user }}"
        WL_PASS: "{{ wl_pass }}"
      ignore_errors: true

    - name: Guardar log del despliegue
      copy:
        content: |
          [{{ fecha_deploy }}] Resultado del despliegue WebLogic:
          WAR: {{ war_path }}
          Hash actual: {{ war_hash_result.stdout.split()[0] }}
          Hash esperado: {{ expected_sha256 }}
          Integridad: {{ war_hash_result.stdout.split()[0] == expected_sha256 }}
          Resultado CLI: {{ deploy_result.stdout }}
        dest: "/opt/logs/deploy_{{ app_name }}_{{ fecha_deploy }}.log"
        mode: '0644'

    - name: Traer log de despliegue al workspace Jenkins
      fetch:
        src: "/opt/logs/deploy_{{ app_name }}_{{ fecha_deploy }}.log"
        dest: "logs/"
        flat: yes

    - name: Mostrar resumen en Jenkins
      debug:
        msg:
          - "📦 WAR desplegado: {{ app_name }} v{{ app_version }}"
          - "🌐 Dominio: {{ dominio }}"
          - "🚀 Resultado: {{ deploy_result.stdout }}"
