---
- name: Desplegar aplicación WAR en WebLogic
  hosts: all
  become: false

  tasks:

    - name: Cargar variables de la aplicación
      include_vars:
        file: "../vars/{{ app_name }}.yml"
        name: app_vars

    - name: Definir nombre del archivo WAR y ruta
      set_fact:
        war_file: "{{ app_vars.app_name }}-{{ app_vars.app_version }}.war"
        war_path: "/opt/deploy/{{ app_vars.app_name }}/{{ app_vars.app_name }}-{{ app_vars.app_version }}.war"
        war_url: "{{ app_vars.nexus_url }}/{{ app_vars.group_path }}/{{ app_vars.app_name }}/{{ app_vars.app_version }}/{{ app_vars.app_name }}-{{ app_vars.app_version }}.war"

    - name: Definir fecha de despliegue
      set_fact:
        fecha_deploy: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"

    - name: Crear carpeta de logs si no existe
      file:
        path: "/opt/logs"
        state: directory
        mode: '0755'

    - name: Descargar WAR desde Nexus
      get_url:
        url: "{{ war_url }}"
        dest: "{{ war_path }}"
        mode: '0644'
        url_username: "{{ app_vars.nexus_user }}"
        url_password: "{{ app_vars.nexus_pass }}"
        use_netrc: false

    - name: Validar integridad del WAR
      command: "sha256sum {{ war_path }}"
      register: war_hash_result
      changed_when: false

    - name: Verificar hash
      assert:
        that:
          - "war_hash_result.stdout.split()[0] == app_vars.expected_sha256"
        fail_msg: "❌ Hash incorrecto"
        success_msg: "✅ Hash correcto"

    - name: Desplegar WAR en WebLogic
      shell: |
        java weblogic.Deployer \
          -adminurl t3://{{ app_vars.dominio }}:7001 \
          -username {{ wl_user }} \
          -password {{ wl_pass }} \
          -deploy \
          -source {{ war_path }} \
          -targets {{ app_vars.targets }} \
          -remote \
          -upload \
          -name {{ app_vars.app_name }} \
          -verbose
      register: deploy_result
      ignore_errors: true

    - name: Mostrar resultado del despliegue
      debug:
        var: deploy_result.stdout_lines

    - name: Guardar log del despliegue
      copy:
        content: |
          [{{ fecha_deploy }}] Despliegue WebLogic:
          App: {{ app_vars.app_name }} v{{ app_vars.app_version }}
          WAR: {{ war_path }}
          Hash actual: {{ war_hash_result.stdout.split()[0] }}
          Hash esperado: {{ app_vars.expected_sha256 }}
          Resultado:
          {{ deploy_result.stdout }}
        dest: "/opt/logs/deploy_{{ app_vars.app_name }}_{{ fecha_deploy }}.log"
        mode: '0644'

    - name: Traer log al workspace Jenkins
      fetch:
        src: "/opt/logs/deploy_{{ app_vars.app_name }}_{{ fecha_deploy }}.log"
        dest: "logs/"
        flat: yes

