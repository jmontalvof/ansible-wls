---
- name: Preparar entorno WebLogic antes del despliegue
  hosts: all
  become: false
  vars_files:
    - ../vars/vars.yml

  tasks:

    - name: Verificar si el puerto 7001 est치 abierto (AdminServer)
      wait_for:
        port: 7001
        state: started
        timeout: 30

    - name: Crear carpeta temporal para el despliegue si no existe
      file:
        path: "/opt/deploy/{{ app_name }}"
        state: directory
        mode: '0755'

    - name: Limpiar carpeta de despliegue anterior
      file:
        path: "/opt/deploy/{{ app_name }}/{{ app_name }}-{{ app_version }}.war"
        state: absent

    - name: Descargar WAR desde Nexus
      get_url:
        url: "{{ nexus_url }}/com/empresa/web/{{ app_name }}/{{ app_version }}/{{ app_name }}-{{ app_version }}.war"
        dest: "/opt/deploy/{{ app_name }}/"
        mode: '0644'

    - name: Guardar log de preparaci칩n
      copy:
        content: |
          [{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}] Preparaci칩n de entorno:
          Puerto 7001 verificado.
          Carpeta /opt/deploy/{{ app_name }} creada.
          WAR anterior eliminado.
          Nuevo WAR descargado: {{ app_name }}-{{ app_version }}.war
        dest: "/opt/logs/prepare_{{ app_name }}_{{ app_version }}.log"
        mode: '0644'

    - name: Traer log de preparaci칩n al workspace Jenkins
      fetch:
        src: "/opt/logs/prepare_{{ app_name }}_{{ app_version }}.log"
        dest: "logs/"
        flat: yes
